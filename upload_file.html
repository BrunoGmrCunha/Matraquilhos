<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Inter" rel="stylesheet">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="blank">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="apple-touch-icon" href="https://brunogmrcunha.github.io/Matraquilhos/images/apple-touch-icon.png">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

  <title>NIUP - Matraquilhos</title>
  <link rel="stylesheet" href="new/style.css">
</head>

<body>
  <div id="content">
    <h2>Upload de Ficheiro das partidas</h2>
    <input type="file" id="fileInput" accept=".json" />
    <button onclick="processFile()">Enviar para API</button>
    <table id="resultTable" border="1">
      <thead>
        <tr>
          <th>Instância</th>
          <th>Criar</th>
          <th>Guardar</th>
          <th>Validar</th>
          <th>Processar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <pre id="output"></pre>
  </div>
  <script>
    let jsonData = null;
    let token = null;
    const BASE_URL = "http://localhost:8004";

    // Lê o ficheiro JSON ao selecionar
    document.getElementById("fileInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          jsonData = JSON.parse(e.target.result);
          document.getElementById("output").textContent =
            JSON.stringify(jsonData, null, 2);
        } catch (err) {
          alert("Erro ao ler JSON: " + err.message);
        }
      };
      reader.readAsText(file);
    });


    // Função para enviar os produtos à API
    async function processFile() {
      try {
        const token = await login("Admin", "Admin");
        if (!token) {
          console.error("Login falhou, abortando.");
          return;
        }

        if (!jsonData || !jsonData.jogos) {
          alert("Nenhum JSON válido carregado!");
          return;
        }

        const instancesFields = convertGamesToForm(jsonData);

        const results = [];

        for (const instanceFields of instancesFields) {
          const row = {
            id: null,
            create: "❌",
            save: "-",
            validate: "-",
            process: "-"
          };

          // 1. Criar instância
          const createResult = await createFormInstance("28065e82-5b13-4102-a8d4-0e5b657c6d1e", instanceFields, token);
          if (!createResult.success) {
            row.create = "❌ " + createResult.error;
            results.push(row);
            continue;
          }
          row.id = createResult.data.id;
          row.create = "✅";

          // 2. Guardar
          const saveResult = await saveFormInstance(row.id, token);
          if (!saveResult.success) {
            row.save = "❌ " + saveResult.error;
            results.push(row);
            continue;
          }
          row.save = "✅";

          // 3. Validar
          const validateResult = await validateFormInstance(row.id, token);
          if (!validateResult.success) {
            row.validate = "❌ " + validateResult.error;
            results.push(row);
            continue;
          }
          if (validateResult.data && validateResult.data.length > 0) {
            row.validate = "❌ " + JSON.stringify(validateResult.data);
            results.push(row);
            continue;
          }
          row.validate = "✅";

          // 4. Processar
          const processResult = await processFormInstance(row.id, token);
          if (!processResult.success) {
            row.process = "❌ " + processResult.error;
            results.push(row);
            continue;
          }
          row.process = "✅";

          results.push(row);
        }

        renderResultsTable(results);

      } catch (err) {
        console.error("Erro no processFile:", err);
      }
    }

    function renderResultsTable(results) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = ""; // limpa antes

      results.forEach(r => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
      <td>${r.id ?? "N/A"}</td>
      <td>${r.create}</td>
      <td>${r.save}</td>
      <td>${r.validate}</td>
      <td>${r.process}</td>
    `;

        tbody.appendChild(tr);
      });
    }



    async function login(username, password) {
      const response = await fetch(`${BASE_URL}/api/Thebox/Login/Local`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) throw new Error("Erro no login");

      const tokenData = await response.json();
      localStorage.setItem("thebox_token", tokenData.accessToken); // ou "token"
      return tokenData.accessToken;
    }

    async function createFormInstance(formId, fields, token) {
      try {
        const response = await fetch(`${BASE_URL}/api/Thebox/Forms/FormInstances`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            id: crypto.randomUUID(),
            formId: formId,
            fields: fields
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function saveFormInstance(instanceId, token) {
      try {
        const response = await fetch(`${BASE_URL}/api/Thebox/Forms/FormInstances/${instanceId}/Saved`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function validateFormInstance(instanceId, token) {
      try {
        const response = await fetch(`${BASE_URL}/api/Thebox/Forms/FormInstances/${instanceId}/ValidationMessages`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function processFormInstance(instanceId, token) {
      try {
        const response = await fetch(`${BASE_URL}/api/Thebox/Forms/FormInstances/${instanceId}/Process`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }



    function convertGamesToForm(json) {
      const games = json.jogos;
      const result = [];

      games.forEach((game, index) => {
        const redPlayers = game.red;
        const whitePlayers = game.white;
        const winnerTeam = game.winner;
        const loserTeam = winnerTeam === 'red' ? 'white' : 'red';
        const winnerPlayers = winnerTeam === 'red' ? redPlayers : whitePlayers;
        const loserPlayers = loserTeam === 'red' ? redPlayers : whitePlayers;

        const converted = {
          addressFields: null,
          currencyFields: null,
          booleanFields: [
            {
              id: generateUUID(),
              value: game.isGameOfDay,
              fieldId: "00000000-0157-0000-0001-000000000e01"
            }
          ],
          dateFields: [
            {
              value: game.startTime,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000003",
            }
          ],
          decimalFields: [
            {
              value: game.isTie && game.isGameOfDay ? 0 : 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000009"
            },
            {
              value: game.isTie ? 0 : 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000008"
            }
          ],
          entityClassificationFields: null,
          entityFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a1",
              fieldMain: true,
              entityId: winnerPlayers[0].id,
              entityFirstName: winnerPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a2",
              fieldMain: false,
              entityId: winnerPlayers[1].id,
              entityFirstName: winnerPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a3",

              fieldMain: false,
              entityId: loserPlayers[0].id,
              entityFirstName: loserPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a4",

              fieldMain: false,
              entityId: loserPlayers[1].id,
              entityFirstName: loserPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            }
          ],
          identityDocumentFields: null,
          numberingFields: [],
          optionFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000011",
              values: [
                {
                  id: winnerTeam === 'red'
                    ? "00000000-0157-0000-0001-000000000002"
                    : "00000000-0157-0000-0001-000000000001",
                  name: winnerTeam === 'red' ? "Vermelho" : "Branco"
                }
              ]
            }
          ],
          paymentTermFields: null,
          priceTableFields: null,
          projectInstanceFields: null,
          textFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000010",
              value: game.time,
            }
          ],
          movementDocumentInstanceFields: null,
          fileFields: null,
          itemFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000036",
              itemId: "669c4bff-f094-4713-96f5-4b23b6358a41",
              itemName: "LIGA 2025"
            }
          ],
          itemClassificationFields: null,
          itemInformationFields: null,
          customFields: null,
          warehouseFields: null,
          stateFields: null,
          cityFields: null,
          countryFields: null
        };

        result.push(converted);
      });

      return result;
    }

    // Função auxiliar para gerar UUIDs temporários
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }


  </script>
</body>

</html>