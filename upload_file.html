<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Inter" rel="stylesheet">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="blank">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="apple-touch-icon" href="https://brunogmrcunha.github.io/Matraquilhos/images/apple-touch-icon.png">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

  <title>NIUP - Matraquilhos</title>
  <link rel="stylesheet" href="new/style.css">

  <style>
    .upload-section {
      background-color: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .upload-section h1 {
      text-align: center;
      color: #0061A8;
      margin-bottom: 10px;
    }

    .upload-section p {
      text-align: center;
      color: #333;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .drop {
      border: 2px dashed #0061A8;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      background-color: #fefefe;
      cursor: pointer;
      transition: background 0.2s ease;
      display: block;
    }

    .drop:hover {
      background-color: #f0f8ff;
    }

    .drop strong {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
    }

    input[type="file"] {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .actions {
      margin-top: 20px;
    }

    button {
      font-size: 18px;
      font-weight: 600;
      background-color: #0061A8;
      color: white;
      border: none;
      border-radius: 10px;
      width: 100%;
      height: 50px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #ccc;
      color: #666;
    }

    .result-section {
      background-color: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #000;
      text-align: center;
    }

    th {
      background-color: #0061A8;
      color: white;
    }
  </style>
</head>

<body>
  <div id="content">
    <!-- <h2>Upload de Ficheiro das partidas</h2>
    <input type="file" id="fileInput" accept=".json" />
    <button onclick="processFile()">Enviar para API</button> -->

    <div class="upload-section">
      <h1>Enviar ficheiro</h1>
      <p>Selecione um ficheiro JSON e submeta para a API.</p>
      <form onsubmit="processFile(event)">
        <div>
          <label for="apiUrl">API URL:</label>
          <input id="apiUrl" type="text" value="http://localhost:8004" />

          <label for="username">Utilizador:</label>
          <input id="username" type="text" value="Admin" />

          <label for="password">Password:</label>
          <input id="password" type="password" value="Admin" />
        </div>

        <label class="drop" for="fileInput">
          <strong>Clique para escolher um ficheiro JSON</strong>
          <span>(ou use a janela do sistema)</span>
        </label>
        <input id="fileInput" name="file" type="file" accept="application/json" required />
        <div id="fileStatus" style="margin-top: 10px; color: #0061A8; font-weight: 600;"></div>
        <div class="actions">
          <button type="submit">Submeter para a API</button>
        </div>
      </form>
    </div>

    <!-- <table id="resultTable" border="1">
      <thead>
        <tr>
          <th>Instância</th>
          <th>Criar</th>
          <th>Guardar</th>
          <th>Validar</th>
          <th>Processar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table> -->
    <div class="result-section">
      <h2>Resultados</h2>
      <table id="resultTable">
        <thead>
          <tr>
            <th>Instância</th>
            <th>Criar</th>
            <th>Guardar</th>
            <th>Validar</th>
            <th>Processar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>


    <pre id="output"></pre>
  </div>
  <script>
    let jsonData = null;
    let token = null;
    const BASE_URL = "http://localhost:8004";

    // Lê o ficheiro JSON ao selecionar
    document.getElementById("fileInput").addEventListener("change", function (event) {
      const statusEl = document.getElementById("fileStatus");

      const file = event.target.files[0];
      if (!file) {
        statusEl.textContent = "";
        jsonData = null;
        return;
      }

      statusEl.textContent = `Ficheiro selecionado e pronto!`;


      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          jsonData = JSON.parse(e.target.result);
          document.getElementById("output").textContent =
            JSON.stringify(jsonData, null, 2);
        } catch (err) {
          alert("Erro ao ler JSON: " + err.message);
          statusEl.textContent = "";
        }
      };
      reader.readAsText(file);
    });


    // Função para enviar os produtos à API
    async function processFile() {
      event.preventDefault();
      const apiUrl = document.getElementById("apiUrl").value;
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const file = document.getElementById("fileInput").files[0];

      if (!jsonData) {
        alert("Por favor, selecione um ficheiro JSON antes de submeter.");
        return;
      }

      // if (file) {
      //   const reader = new FileReader();
      //   reader.onload = function (e) {
      //     try {
      //       jsonData = JSON.parse(e.target.result);
      //       console.log("Conteúdo JSON:", jsonData);
      //       // Aqui podes usar jsonData para enviar para a API
      //     } catch (err) {
      //       console.error("Erro ao ler o JSON:", err);
      //       return;
      //     }
      //   };
      //   reader.readAsText(file);
      // }

      try {

        const loginResult = await login(apiUrl, username, password);
        if (!loginResult.success) {
          alert("❌ Erro no Login: " +loginResult.error  )
          return;
        }
        const token = loginResult.data.accessToken;
        if (!token) {
          alert("Erro no Login!");
          console.error("Login falhou, abortando.");
          return;
        }

        if (!jsonData || !jsonData.jogos) {
          alert("Nenhum JSON válido carregado!");
          return;
        }

        const instancesFields = convertGamesToForm(jsonData);

        const results = [];

        for (const instanceFields of instancesFields) {
          const row = {
            id: null,
            create: "❌",
            save: "-",
            validate: "-",
            process: "-"
          };

          // 1. Criar instância
          const createResult = await createFormInstance(apiUrl, "28065e82-5b13-4102-a8d4-0e5b657c6d1e", instanceFields, token);
          if (!createResult.success) {
            row.create = "❌ " + createResult.error;
            results.push(row);
            continue;
          }
          row.id = createResult.data.id;
          row.create = "✅";

          // 2. Guardar
          const saveResult = await saveFormInstance(apiUrl, row.id, token);
          if (!saveResult.success) {
            row.save = "❌ " + saveResult.error;
            results.push(row);
            continue;
          }
          row.save = "✅";

          // 3. Validar
          const validateResult = await validateFormInstance(apiUrl, row.id, token);
          if (!validateResult.success) {
            row.validate = "❌ " + validateResult.error;
            results.push(row);
            continue;
          }
          if (validateResult.data && validateResult.data.length > 0) {
            row.validate = "❌ " + JSON.stringify(validateResult.data);
            results.push(row);
            continue;
          }
          row.validate = "✅";

          // 4. Processar
          const processResult = await processFormInstance(apiUrl, row.id, token);
          if (!processResult.success) {
            row.process = "❌ " + processResult.error;
            results.push(row);
            continue;
          }
          row.process = "✅";
          
          // 4. Get
          const getInstanceResult = await getFormInstance(apiUrl,token);
          if (!getInstanceResult.success) {
            continue;
          }
          row.id = getInstanceResult.data.instanceNumber;

          results.push(row);
          renderResultsTable(results);

        }

        renderResultsTable(results);

        document.getElementById("fileStatus").textContent =
          `Ficheiro submetido com sucesso!`;

      } catch (err) {
        console.error("Erro no processFile:", err);
      }
    }

    function renderResultsTable(results) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = ""; // limpa antes

      results.forEach(r => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
      <td>${r.id ?? "N/A"}</td>
      <td>${r.create}</td>
      <td>${r.save}</td>
      <td>${r.validate}</td>
      <td>${r.process}</td>
    `;

        tbody.appendChild(tr);
      });
    }



    async function login(api, username, password) {
      try {
        const response = await fetch(`${api}/api/Thebox/Login/Local`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };

      }
      catch (err) {
        return { success: false, error: err.message };
      }

    }

    async function createFormInstance(api, formId, fields, token) {
      try {
        const response = await fetch(`${api}/api/Thebox/Forms/FormInstances`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            id: crypto.randomUUID(),
            formId: formId,
            fields: fields
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function saveFormInstance(api, instanceId, token) {
      try {
        const response = await fetch(`${api}/api/Thebox/Forms/FormInstances/${instanceId}/Saved`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function validateFormInstance(api, instanceId, token) {
      try {
        const response = await fetch(`${api}/api/Thebox/Forms/FormInstances/${instanceId}/ValidationMessages`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function processFormInstance(api, instanceId, token) {
      try {
        const response = await fetch(`${api}/api/Thebox/Forms/FormInstances/${instanceId}/Process`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    async function getFormInstance(api, instanceId, token) {
      try {
        const response = await fetch(`${api}/api/Thebox/Forms/FormInstances/${instanceId}`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json"
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          return { success: false, error: `Erro HTTP ${response.status}: ${errorText}` };
        }

        const data = await response.json();
        return { success: true, data };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }


    function convertGamesToForm(json) {
      const games = json.jogos;
      const result = [];

      games.forEach((game, index) => {
        const redPlayers = game.red;
        const whitePlayers = game.white;
        const winnerTeam = game.winner;
        const loserTeam = winnerTeam === 'red' ? 'white' : 'red';
        const winnerPlayers = winnerTeam === 'red' ? redPlayers : whitePlayers;
        const loserPlayers = loserTeam === 'red' ? redPlayers : whitePlayers;

        const converted = {
          addressFields: null,
          currencyFields: null,
          booleanFields: [
            {
              id: generateUUID(),
              value: game.isGameOfDay,
              fieldId: "00000000-0157-0000-0001-000000000e01"
            }
          ],
          dateFields: [
            {
              value: game.startTime,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000003",
            }
          ],
          decimalFields: [
            {
              value: game.isTie ? 0 : 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000009"
            },
            {
              value: game.isTie ? 0 : 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000008"
            }
          ],
          entityClassificationFields: null,
          entityFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a1",
              fieldMain: true,
              entityId: winnerPlayers[0].id,
              entityFirstName: winnerPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a2",
              fieldMain: false,
              entityId: winnerPlayers[1].id,
              entityFirstName: winnerPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a3",

              fieldMain: false,
              entityId: loserPlayers[0].id,
              entityFirstName: loserPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a4",

              fieldMain: false,
              entityId: loserPlayers[1].id,
              entityFirstName: loserPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            }
          ],
          identityDocumentFields: null,
          numberingFields: [],
          optionFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000011",
              values: [
                {
                  id: winnerTeam === 'red'
                    ? "00000000-0157-0000-0001-000000000002"
                    : "00000000-0157-0000-0001-000000000001",
                  name: winnerTeam === 'red' ? "Vermelho" : "Branco"
                }
              ]
            }
          ],
          paymentTermFields: null,
          priceTableFields: null,
          projectInstanceFields: null,
          textFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000010",
              value: game.time,
            }
          ],
          movementDocumentInstanceFields: null,
          fileFields: null,
          itemFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000036",
              itemId: "669c4bff-f094-4713-96f5-4b23b6358a41",
              itemName: "LIGA 2025"
            }
          ],
          itemClassificationFields: null,
          itemInformationFields: null,
          customFields: null,
          warehouseFields: null,
          stateFields: null,
          cityFields: null,
          countryFields: null
        };

        result.push(converted);
      });

      return result;
    }

    // Função auxiliar para gerar UUIDs temporários
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }


  </script>
</body>

</html>