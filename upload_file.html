<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <title>Upload JSON e Criar Produtos</title>
</head>

<body>
  <h2>Upload de Ficheiro JSON</h2>
  <input type="file" id="fileInput" accept=".json" />
  <button onclick="processFile()">Enviar para API</button>

  <pre id="output"></pre>

  <script>
    let jsonData = null;
    let token = null;
    const BASE_URL = "http://localhost:8004";

    // Lê o ficheiro JSON ao selecionar
    document.getElementById("fileInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          jsonData = JSON.parse(e.target.result);
          document.getElementById("output").textContent =
            JSON.stringify(jsonData, null, 2);
        } catch (err) {
          alert("Erro ao ler JSON: " + err.message);
        }
      };
      reader.readAsText(file);
    });


    // Função para enviar os produtos à API
    async function processFile() {
      let token = login("Admin", "Admin");
      console.log(token)
      console.log(jsonData)
      if (!jsonData || !jsonData.jogos) {
        alert("Nenhum JSON válido carregado!");
        return;
      }
      let convertedData = convertGamesToForm(jsonData);

      document.getElementById("output").textContent =
        JSON.stringify(convertedData, null, 2);
    }

    async function login(username, password) {
      const response = await fetch(`${BASE_URL}/api/Thebox/Login/Local`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) throw new Error("Erro no login");

      const tokenData = await response.json();
      localStorage.setItem("thebox_token", tokenData.accessToken); // ou "token"
      return tokenData.accessToken;
    }

    async function criarFormInstance() {
      try {

        const response = await fetch(`${BASE_URL}/api/Thebox/Forms/FormInstances`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            id: crypto.randomUUID(), // ID único para a instância
            formId: "28065e82-5b13-4102-a8d4-0e5b657c6d1e",
            fields: {}
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }

        return data = await response.json();
        console.log("Resposta da API:", data);
      } catch (err) {
        console.error("Erro ao chamar API:", err);
      }
    }

    function convertGamesToForm(json) {
      const games = json.jogos;
      const result = [];

      games.forEach((game, index) => {
        const redPlayers = game.red;
        const whitePlayers = game.white;
        const winnerTeam = game.winner;
        const loserTeam = winnerTeam === 'red' ? 'white' : 'red';
        const winnerPlayers = winnerTeam === 'red' ? redPlayers : whitePlayers;
        const loserPlayers = loserTeam === 'red' ? redPlayers : whitePlayers;

        const converted = {
          addressFields: null,
          currencyFields: null,
          booleanFields: [
            {
              id: generateUUID(),
              value: game.isGameOfDay,
              fieldId: "00000000-0157-0000-0001-000000000e01"
            }
          ],
          dateFields: [
            {
              value: game.startTime,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000003",
            }
          ],
          decimalFields: [
            {
              value: 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000009"
            },
            {
              value: 1,
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000008"
            }
          ],
          entityClassificationFields: null,
          entityFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-0000000000a1",
              fieldMain: true,
              entityId: winnerPlayers[0].id,
              entityFirstName: winnerPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldMain: false,
              entityId: winnerPlayers[1].id,
              entityFirstName: winnerPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldMain: false,
              entityId: loserPlayers[0].id,
              entityFirstName: loserPlayers[0].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            },
            {
              id: generateUUID(),
              fieldMain: false,
              entityId: loserPlayers[1].id,
              entityFirstName: loserPlayers[1].name,
              entityMiddleName: null,
              entityLastName: null,
              entityAlias: null,
              entityNiupId: null
            }
          ],
          identityDocumentFields: null,
          numberingFields: [],
          optionFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000011",
              values: [
                {
                  id: winnerTeam === 'red'
                    ? "00000000-0157-0000-0001-000000000002"
                    : "00000000-0157-0000-0001-000000000001",
                  name: winnerTeam === 'red' ? "Vermelho" : "Branco"
                }
              ]
            }
          ],
          paymentTermFields: null,
          priceTableFields: null,
          projectInstanceFields: null,
          textFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000010",
              value: game.time,
            }
          ],
          movementDocumentInstanceFields: null,
          fileFields: null,
          itemFields: [
            {
              id: generateUUID(),
              fieldId: "00000000-0157-0000-0001-000000000036",
              itemId: "669c4bff-f094-4713-96f5-4b23b6358a41",
              itemName: "LIGA 2025"
            }
          ],
          itemClassificationFields: null,
          itemInformationFields: null,
          customFields: null,
          warehouseFields: null,
          stateFields: null,
          cityFields: null,
          countryFields: null
        };

        result.push(converted);
      });

      return result;
    }

    // Função auxiliar para gerar UUIDs temporários
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }


  </script>
</body>

</html>